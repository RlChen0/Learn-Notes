# 实验记录

开始时间：2021/10/9 18:51

环境：basenji

工作目录：~/workspace

## 目的

利用basenji_motifs.py 绘制motif，heatmap。

## 命令及结果

### version1

```shell
bsub -q gpu -m gpu01 -o ./report/20211009/motif_1_out -e ./report/20211009/motif_1_err "basenji_motifs.py -d --heat -o basenji2_motif --tfr valid ./params/params_131k_24.json ./models/basenji2_IRGSP_24/model_best.h5 ./data/IRGSP20/"
```

#### error

```python
Traceback (most recent call last):
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 793, in <module>
    main()
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 79, in main
    default='%s/cisbp/Homo_sapiens.meme' % os.environ['HG38'],
  File "/public/home/xwli/anaconda3/envs/basenji/lib/python3.8/os.py", line 675, in __getitem__
    raise KeyError(key) from None
KeyError: 'HG38'
```

#### 原因

未设定motif 注释数据

#### 处理

下载注释数据 

```shell
wget https://meme-suite.org/meme/meme-software/Databases/motifs/motif_databases.12.21.tgz
```

解压

```shell
tar -xzvf motif_databases.12.21.tgz 
```

### version2

```shell
bsub -q gpu -m gpu01 -o ./report/20211009/motif_2_out -e ./report/20211009/motif_2_err "basenji_motifs.py -d --heat -m ./data/motif_databases/CIS-BP_2.00/Oryza_sativa.meme -o basenji2_motif --tfr valid ./params/params_131k_24.json ./models/basenji2_IRGSP_24/model_best.h5 ./data/IRGSP20/"
```

#### error

与version 1 报错相同

##### 处理

修改basenji_motifs.py 

```python
  parser.add_option('-m', dest='meme_db',
      default='%s/cisbp/Homo_sapiens.meme' % os.environ['HG38'],
      help='MEME database used to annotate motifs')
```



```python
  parser.add_option('-m', dest='meme_db',
      default='/cisbp/Homo_sapiens.meme' ,
      help='MEME database used to annotate motifs')
```

#### error2

```python
Traceback (most recent call last):
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 793, in <module>
    main()
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 121, in main
    split_label=options.split_label,
AttributeError: 'Values' object has no attribute 'split_label'
```

##### 处理

添加split_label参数

```python
  parser.add_option('--split', dest='split_label',
      default='test',
      help='Dataset split label for eg TFR pattern [Default: %default]')
```

### version3

```shell
bsub -q gpu -m gpu01 -o ./report/20211009/motif_3_out -e ./report/20211009/motif_3_err "basenji_motifs.py -d --heat --split valid -m ./data/motif_databases/CIS-BP_2.00/Oryza_sativa.meme -o basenji2_motif --tfr valid ./params/params_131k_24.json ./models/basenji2_IRGSP_24/model_best.h5 ./data/basenji2_data/IRGSP20"
```

#### error

```python
Traceback (most recent call last):
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 796, in <module>
    main()
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 123, in main
    eval_data = dataset.SeqDataset(data_dir,
  File "/public/home/xwli/workspace/basenji/basenji/dataset.py", line 61, in __init__
    self.compute_stats()
  File "/public/home/xwli/workspace/basenji/basenji/dataset.py", line 158, in compute_stats
    dataset = tf.data.Dataset.list_files(self.tfr_path)
  File "/public/home/xwli/anaconda3/envs/basenji/lib/python3.8/site-packages/tensorflow/python/data/ops/dataset_ops.py", line 1224, in list_files
    assert_not_empty = control_flow_ops.Assert(
  File "/public/home/xwli/anaconda3/envs/basenji/lib/python3.8/site-packages/tensorflow/python/util/dispatch.py", line 201, in wrapper
    return target(*args, **kwargs)
  File "/public/home/xwli/anaconda3/envs/basenji/lib/python3.8/site-packages/tensorflow/python/util/tf_should_use.py", line 247, in wrapped
    return _add_should_use_warning(fn(*args, **kwargs),
  File "/public/home/xwli/anaconda3/envs/basenji/lib/python3.8/site-packages/tensorflow/python/ops/control_flow_ops.py", line 154, in Assert
    raise errors.InvalidArgumentError(
tensorflow.python.framework.errors_impl.InvalidArgumentError: Expected 'tf.Tensor(False, shape=(), dtype=bool)' to be true. Summarized data: b'No files matched pattern: ./data/basenji2_data/IRGSP20/tfrecords/valid'

```

--tfr 参数为添加子目录

### version4

```shell
bsub -q gpu -m gpu01 -o ./report/20211009/motif_4_out -e ./report/20211009/motif_4_err "basenji_motifs.py -d --heat --split valid -m ./data/motif_databases/CIS-BP_2.00/Oryza_sativa.meme -o basenji2_motif ./params/params_131k_24.json   ./models/basenji2_IRGSP_24/model_best.h5 ./data/basenji2_data/IRGSP20"
```

#### error

```python
Traceback (most recent call last):
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 796, in <module>
    main()
  File "/public/home/xwli/workspace/basenji/bin/basenji_motifs.py", line 179, in main
    plot_filter_logo(filter_outs[:, :, f], filter_size,
IndexError: index 24 is out of bounds for axis 2 with size 24

```

#### 处理

发现basenji_motifs.py 中filters_out 为最后输出层

```python

```

#### error2

显存不足

```python
tensorflow.python.framework.errors_impl.ResourceExhaustedError:  OOM when allocating tensor with shape[4,1,131072,288] and type float on /job:localhost/replica:0/task:0/device:GPU:0 by allocator GPU_0_bfc
	 [[{{node model_2/conv1d/conv1d-0-0-TransposeNCHWToNHWC-LayoutOptimizer}}]]
Hint: If you want to see a list of allocated tensors when OOM happens, add report_tensor_allocations_upon_oom to RunOptions for current allocation info.
 [Op:__inference_predict_function_2995]
```

将batch_size 修改为1

仍旧不足

提交至high 使用CPU运行

报错

缺少tomtom软件，安装meme

```shell
       ========================
        Configuration parameters
        ========================

  Install path:               /public/home/xwli/meme
  Install UID:                
  Version:                    5.4.1
  C compiler:                 gcc
  C compiler flags:           -std=gnu89 -fno-common -Wall -Wno-unused -DUNIX -D__USE_FIXED_PROTOTYPES__   -O3
  Linker:                     /bin/ld -m elf_x86_64
  Special Libs:               -lz -lm 
  MPICC:                      gcc
  MPIRUN:                     
  MPI_CMD:                    
  MPIINC:                     
  MPILIBDIR:                  
  MPIFLAGS:                   
  MPI_NPROCS:                 1
  OPAL URL:                   no
  OPAL DEPLOY DIRECTORY:      
  BUILD LIBXML2:              yes
  LIBXML2 compiler flags:     -I${top_srcdir}/src/libxml2/include
  LIBXML2 libs:               ${top_builddir}/src/libxml2/libxml2.la
  BUILD LIBXSLT:              yes
  LIBXSLT compiler flags:     -I${top_srcdir}/src/
  LIBXSLT libs:               ${top_builddir}/src/libxslt/libxslt.la
  SOURCE URL:		      https://meme-suite.org
  WEBSITE URL:                https://meme-suite.org/meme
  ALTERNATE WEBSITE URL:      
  PREVIOUS VERSION URL:       
  PREVIOUS VERSION:           
  NOTICES URL:                ./notices.txt
  NEWS URL:                   ./news.txt
  WEBSITE CONTACT:            
  DEVELOPER CONTACT:          meme-suite@uw.edu
  GO-SERVER URL:              http://amigo.geneontology.org/amigo/term/GO_TERM_ID
  MEME DB:                    ${datarootdir}/${PACKAGE_NAME}-5.4.1/db
  MEME LOGS:                  ${localstatedir}/${PACKAGE_NAME}-5.4.1/LOGS
  MEME TEMP FILES:            
  PERL:                       /bin/perl
  PYTHON:                     /public/home/xwli/anaconda3/envs/basenji/bin/python
  PYTHON VERSiON:             3.8
  CONVERT:                    
  GHOSTSCRIPT:                /bin/gs
  QUOTA:                      
  EXPIRY:                     4
  DRMAA QUEUE:                
  DRMAA QUEUE SHORT:          
  MAXTIME:                    14400
  MAXTIME SHORT:              300
  MAXMEMORY:                  4
  MAXMEMORY SHORT:            1
  STREME LENGTH FACTOR:       1e6

  Run the following commands to compile, test and install meme:
        make
        make test
        make install

  Then make sure that the following two directories are added to
  your PATH variable:
        /public/home/xwli/meme/bin
        /public/home/xwli/meme/libexec/meme-5.4.1

  This can often be done by editing the file named .profile to add
  the following line:
	export PATH=/public/home/xwli/meme/bin:/public/home/xwli/meme/libexec/meme-5.4.1:$PATH

```

### version 5

```shell
bsub -q high -R "rusage[mem=50GB]" -o ./report/20211011/motif_out1 -e ./report/20211011/motif_e1 "basenji_motifs.py -d --heat --split valid -m ./data/motif_databases/CIS-BP_2.00/Oryza_sativa.meme -o basenji2_motif ./params/params_131k_24.json   ./models/basenji2_IRGSP_24/model_best.h5 ./data/basenji2_data/IRGSP20"
```

